#!/bin/sh
echo
echo " Package expansion"

DIR="/initrd/mnt/dev_save/scriptek/1_OS_BUILDER/Test04/tmp/repo"
F="$DIR/extended_list"
F2="${F}_2"
F3="${F}_3"
F4="${F}_4"
ARCH="i386"
[ "$ARCH" == "i386" ]&& GREPV="amd64"
rm -f ${F}*
touch $F $F2 $F3

echo "openbox" | tee $F $F3

while [ ! -z "$(cat $F)" -o ! -z "$(cat $F2)" ];do
 [ ! -z "$(cat $F)" ]&& SP="$F" && FF="$F2 $F3"
 [ ! -z "$(cat $F2)" ]&& SP="$F2" && FF="$F3"
 SP="$(cat $SP | head -n1)"
 if [ "$SP" ];then
 echo "########## $SP depends:"
  NPKGS="$(sed -n "/^Package: ${SP}$/ , /^$/p" $DIR/* | grep "^Depends: " |
  sed -e 's/^Depends: \|([^)]*)//g ; s/, /\n/g ; s/,//g' | cut -f1 -d' ')"
  if [ "$NPKGS" ];then
   for i in $NPKGS;do
   [ ! "$(cat $F3 | grep "^$i$")" ] && \
   [ ! "$(grep ".*cross.*\|.*$GREPV.*\|.*dev.*\|libc6-x32" <<< "$i")" ]&&\
   tee -a $FF <<< "$i"
   done
  fi
 [ "$(cat $F)" != '' ]&& sed -i '1 d' "$F"
 [ "$(cat $F2)" != '' ]&& sed -i '1 d' "$F2"
 fi

done

